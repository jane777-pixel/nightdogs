{# Webmentions styles will be in external CSS #}

{%- set mentionsForUrl = webmentions.mentions | mentionsForUrl(webmentionsUrl) -%}
{%- set likes = mentionsForUrl | mentionType('like-of') -%}
{%- set reposts = mentionsForUrl | mentionType('repost-of') -%}
{%- set replies = mentionsForUrl | mentionType('in-reply-to') -%}
{%- set mentions = mentionsForUrl | mentionType('mention-of') -%}
{%- set totalInteractions = likes.length + reposts.length + replies.length + mentions.length -%}

{% if mentionsForUrl.length %}
<section class="webmentions" id="webmentions">
	<div class="webmentions-header">
		<h3>
			<span class="webmentions-icon" aria-hidden="true">üí¨</span>
			Conversations
		</h3>
		<p class="webmentions-summary">
			{{ totalInteractions }} interaction{{ 's' if totalInteractions != 1 }}
			{% if likes.length %} ‚Ä¢ {{ likes.length }} like{{ 's' if likes.length != 1 }}{% endif %}
			{% if reposts.length %} ‚Ä¢ {{ reposts.length }} share{{ 's' if reposts.length != 1 }}{% endif %}
			{% if replies.length + mentions.length %} ‚Ä¢ {{ replies.length + mentions.length }} mention{{ 's' if (replies.length + mentions.length) != 1 }}{% endif %}
		</p>
	</div>

	{% if likes.length or reposts.length %}
	<div class="webmentions-quick-actions">
		{% if likes.length %}
		<div class="facepile-section">
			<h4>
				<span class="facepile-icon" aria-hidden="true">‚ù§Ô∏è</span>
				Liked by {{ likes.length }} people
			</h4>
			<div class="facepile" role="group" aria-label="People who liked this post">
				{% for like in likes %}
				<a
					href="{{ like.author.url }}"
					title="{{ like.author.name }} liked this post"
					class="facepile-item"
					rel="nofollow"
				>
					<img
						src="{{ like.author.photo }}"
						alt="{{ like.author.name }}"
						class="u-photo"
						loading="lazy"
						width="40"
						height="40"
					/>
				</a>
				{% endfor %}
			</div>
		</div>
		{% endif %}

		{% if reposts.length %}
		<div class="facepile-section">
			<h4>
				<span class="facepile-icon" aria-hidden="true">üîÑ</span>
				Shared by {{ reposts.length }} people
			</h4>
			<div class="facepile" role="group" aria-label="People who shared this post">
				{% for repost in reposts %}
				<a
					href="{{ repost.author.url }}"
					title="{{ repost.author.name }} shared this post"
					class="facepile-item"
					rel="nofollow"
				>
					<img
						src="{{ repost.author.photo }}"
						alt="{{ repost.author.name }}"
						class="u-photo"
						loading="lazy"
						width="40"
						height="40"
					/>
				</a>
				{% endfor %}
			</div>
		</div>
		{% endif %}
	</div>
	{% endif %}

	{% if replies.length or mentions.length %}
	<div class="webmentions-detailed">
		<h4>
			<span class="webmentions-icon" aria-hidden="true">üí≠</span>
			Replies & Mentions
		</h4>
	</div>
	{% endif %}

	<ol class="webmention-list">
        {% for mention in mentionsForUrl %}
    <li class="webmention h-cite">
      <div class="webmention-author">
        {% set author = (mention.data and mention.data.author) or mention.author %}
        {% set url = (mention.data and mention.data.url) or mention.url %}
        {% set publishedRaw = mention.verified_date or (mention.data and mention.data.published) or mention.published or (mention.data and mention.data.verified_date) or (mention.data and mention.data['wm-received']) or mention['wm-received'] %}
        {% set published = false %}
        {% if publishedRaw and publishedRaw is string and publishedRaw != '' %}
          {# Handle timezone offset conversion: +00:00 to Z #}
          {% if '+00:00' in publishedRaw %}
            {% set published = publishedRaw.replace('+00:00', 'Z') %}
          {% elif '+' in publishedRaw and publishedRaw | length > 19 %}
            {# Handle other timezone offsets like +01:00, +02:00, etc. - convert to Z for simplicity #}
            {% set published = publishedRaw | truncate(19, true, '') + 'Z' %}
          {% elif 'Z' in publishedRaw and 'T' in publishedRaw %}
            {% set published = publishedRaw %}
          {% else %}
            {# Try to parse as date and convert to ISO #}
            {% set published = publishedRaw | date('iso') %}
          {% endif %}
        {% elif publishedRaw %}
          {# Non-string date, convert to ISO #}
          {% set published = publishedRaw | date('iso') %}
        {% endif %}
        {% set content = (mention.data and mention.data.content) or (mention.content and mention.content.html) %}
        {% if author %}
          <a href="{{ author.url }}" class="u-author">
            <img
              src="{{ author.photo }}"
              alt="{{ author.name }}"
              class="u-photo"
              loading="lazy"
              width="48"
              height="48"
            />
            <strong class="p-name">{{ author.name }}</strong>
          </a>
        {% endif %}
        {% if url and published %}
          <a href="{{ url }}" class="u-url">
            <time datetime="{{ published }}">
              {% set dateObj = publishedRaw | dateObject %}
              {% if dateObj %}
                {{ dateObj | readableDate }}
              {% else %}
                {{ published | truncate(10, true, '') | replace('-', ' ') }}
              {% endif %}
            </time>
          </a>
        {% endif %}
      </div>
      <div class="webmention-content p-content">
        {% if content %}
          {{ content | safe }}
        {% elif mention['wm-property'] == 'mention-of' %}
          Mentioned this post on <a href="{{ url }}">{{ url }}</a>.
        {% endif %}
      </div>
    </li>
  {% endfor %}
	</ol>
</div>
{% endif %}
