{# Content Recommendations Widget #}
{# This include should be called with: {% include "recommendations.njk" %} #}

<style>
.recommendations-widget {
  margin: 4rem 0 2rem 0;
  padding: 2rem;
  background: var(--background-color);
  border: 2px solid var(--primary);
  border-radius: 12px;
  position: relative;
  overflow: hidden;
}

.recommendations-widget::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--color), var(--primary));
}

.recommendations-header {
  text-align: center;
  margin-bottom: 2rem;
}

.recommendations-title {
  font-size: 1.8rem;
  margin: 0 0 0.5rem 0;
  color: var(--color);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.recommendations-subtitle {
  font-size: 1rem;
  color: var(--muted-color);
  margin: 0;
}

.recommendation-sections {
  display: grid;
  gap: 2rem;
}

.recommendation-section {
  margin-bottom: 2rem;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--color);
}

.recommendation-grid {
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 1.5rem !important;
  align-items: stretch !important;
  justify-content: flex-start !important;
}

.recommendation-card {
  display: block !important;
  flex: 1 1 calc(50% - 0.75rem) !important;
  min-width: 300px !important;
  max-width: 500px !important;
  padding: 1.5rem !important;
  border: 2px solid var(--primary) !important;
  border-radius: 12px !important;
  transition: all 0.2s ease !important;
  background: var(--background-color) !important;
  text-decoration: none !important;
  color: inherit !important;
  position: relative !important;
  box-sizing: border-box !important;
  overflow: hidden !important;
  contain: layout style !important;
}

.recommendation-card:hover {
  background: var(--primary);
  color: var(--background-color);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  text-decoration: none;
  border-color: var(--color);
}

.recommendation-card:hover * {
  color: inherit;
}

.rec-post-title {
  margin: 0 0 0.75rem 0 !important;
  font-size: 1.1rem !important;
  font-weight: 600 !important;
  line-height: 1.3 !important;
  display: block !important;
  width: 100% !important;
}

.rec-post-meta {
  display: block !important;
  font-size: 0.85rem !important;
  opacity: 0.8 !important;
  margin-bottom: 0.75rem !important;
  width: 100% !important;
}

.rec-post-meta span {
  display: inline !important;
  margin-right: 0.75rem !important;
}

.rec-post-excerpt {
  font-size: 0.9rem !important;
  line-height: 1.5 !important;
  margin: 0 0 1rem 0 !important;
  opacity: 0.9 !important;
  display: block !important;
  width: 100% !important;
}

.rec-author-link {
  color: inherit;
  text-decoration: none;
  font-weight: 500;
}

.rec-author-link:hover {
  text-decoration: underline;
}

.recommendation-card:hover .rec-author-link {
  color: inherit;
  text-decoration: none;
}

.recommendation-card:hover .rec-author-link:hover {
  text-decoration: underline;
}

.shared-tags {
  display: flex !important;
  gap: 0.25rem !important;
  margin-top: 0.5rem !important;
  flex-wrap: wrap !important;
  width: 100% !important;
}

.shared-tag {
  background: var(--muted-color) !important;
  color: var(--background-color) !important;
  padding: 0.1rem 0.4rem !important;
  border-radius: 8px !important;
  font-size: 0.7rem !important;
  font-weight: 500 !important;
  display: inline-block !important;
}

.recommendation-card:hover .shared-tag {
  background: rgba(255,255,255,0.3);
}

/* Remove h-card styling from author links within recommendation cards */
.recommendation-card .h-card,
.recommendation-card .rec-author-link.h-card,
.recommendations-widget .h-card {
  border: none !important;
  background: none !important;
  padding: 0 !important;
  margin: 0 !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  display: inline !important;
  position: static !important;
  overflow: visible !important;
  contain: none !important;
}

/* Ensure author links are properly contained within cards */
.recommendation-card .rec-post-meta span {
  display: inline !important;
  margin-right: 0.75rem !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  max-width: 100% !important;
}

.recommendation-card .rec-author-link {
  display: inline !important;
  color: inherit !important;
  text-decoration: none !important;
  font-weight: 500 !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  max-width: 200px !important;
  vertical-align: baseline !important;
}

/* Force all recommendation card content to stay contained */
.recommendation-card * {
  box-sizing: border-box !important;
  max-width: 100% !important;
  overflow: hidden !important;
  position: relative !important;
}

/* Ensure proper card structure and prevent element separation */
.recommendation-card {
  contain: layout style paint !important;
  isolation: isolate !important;
}

.view-more-section {
  text-align: center;
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid var(--primary);
}

.view-more-links {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

.view-more-link {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1.2rem;
  background: var(--primary);
  color: var(--background-color);
  text-decoration: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.view-more-link:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  text-decoration: none;
}

.view-more-link:hover * {
  color: inherit;
}

.algorithm-note {
  text-align: center;
  margin-top: 1.5rem;
  font-size: 0.8rem;
  color: var(--muted-color);
  opacity: 0.7;
  font-style: italic;
}

@media (max-width: 768px) {
  .recommendations-widget {
    padding: 1.5rem;
    margin: 3rem 0 1rem 0;
  }

  .recommendations-title {
    font-size: 1.5rem;
  }

  .recommendation-grid {
    display: block !important;
  }

  .recommendation-card {
    display: block !important;
    width: 100% !important;
    margin: 0 0 1rem 0 !important;
    min-width: unset !important;
    max-width: none !important;
    flex: none !important;
    padding: 1rem !important;
  }

  .view-more-links {
    flex-direction: column;
    align-items: center;
  }

  .view-more-link {
    width: 100%;
    max-width: 250px;
    justify-content: center;
  }
}
</style>

<div class="recommendations-widget">
  <div class="recommendations-header">
    <h2 class="recommendations-title">
      <span>üîç</span>
      Discover More
    </h2>
    <p class="recommendations-subtitle">
      Curated content based on this post's topics and author
    </p>
  </div>

  <div class="recommendation-sections">
    <!-- Related Posts by Tags -->
    {% set relatedByTags = collections.posts | relatedPosts(page, 3) %}
    {% if relatedByTags.length > 0 %}
      <div class="recommendation-section">
        <h3 class="section-header">
          <span>üè∑Ô∏è</span>
          Similar Topics
        </h3>
        <div class="recommendation-grid">
          {% for related in relatedByTags %}
            {% set post = related.post %}
            {% if post.data.title and post.data.author and authors[post.data.author] and post.url %}
            <a href="{{ post.url }}" class="recommendation-card">
              <h4 class="rec-post-title">{{ post.data.title }}</h4>
              <div class="rec-post-meta">
                {% if post.date %}
                  {% set parsedDate = post.date | parseCMSDate %}
                  {% if parsedDate %}
                    <span>{{ parsedDate | readableDate }}</span>
                  {% endif %}
                {% endif %}
                <span>by <span class="rec-author-link">{{ authors[post.data.author].name }}</span></span>
                {% if post.data.readingTime %}
                  <span>{{ post.data.readingTime.text }}</span>
                {% endif %}
              </div>
              {% if post.data.description %}
                <p class="rec-post-excerpt">{{ post.data.description | truncate(120) }}</p>
              {% endif %}
              {% if related.sharedTags.length > 0 %}
                <div class="shared-tags">
                  {% for tag in related.sharedTags | head(3) %}
                    <span class="shared-tag">#{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- More from Same Author -->
    {% if author %}
      {% set authorPosts = collections.posts | filterByAuthor(author) | reverse %}
      {% set otherAuthorPosts = authorPosts | reject("url", page.url) | head(2) %}
      {% if otherAuthorPosts.length > 0 %}
        <div class="recommendation-section">
          <h3 class="section-header">
            <span>‚úçÔ∏è</span>
            More from {{ authors[author].name }}
          </h3>
          <div class="recommendation-grid">
            {% for post in otherAuthorPosts %}
              {% if post.data.title and post.data.author and authors[post.data.author] and post.url %}
              <a href="{{ post.url }}" class="recommendation-card">
                <h4 class="rec-post-title">{{ post.data.title }}</h4>
                <div class="rec-post-meta">
                  {% if post.date %}
                    {% set parsedDate = post.date | parseCMSDate %}
                    {% if parsedDate %}
                      <span>{{ parsedDate | readableDate }}</span>
                    {% endif %}
                  {% endif %}
                  {% if post.data.readingTime %}
                    <span>{{ post.data.readingTime.text }}</span>
                  {% endif %}
                </div>
                {% if post.data.description %}
                  <p class="rec-post-excerpt">{{ post.data.description | truncate(120) }}</p>
                {% endif %}
              </a>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endif %}

    <!-- Fresh Perspectives (Other Authors) -->
    {% set otherAuthorsPosts = collections.posts | diversePosts(author, 3) %}
    {% if otherAuthorsPosts.length > 0 %}
      <div class="recommendation-section">
        <h3 class="section-header">
          <span>üåü</span>
          Fresh Perspectives
        </h3>
        <div class="recommendation-grid">
          {% for post in otherAuthorsPosts %}
            {% if post.data.title and post.data.author and authors[post.data.author] and post.url %}
            <a href="{{ post.url }}" class="recommendation-card">
              <h4 class="rec-post-title">{{ post.data.title }}</h4>
              <div class="rec-post-meta">
                {% if post.date %}
                  {% set parsedDate = post.date | parseCMSDate %}
                  {% if parsedDate %}
                    <span>{{ parsedDate | readableDate }}</span>
                  {% endif %}
                {% endif %}
                {% if post.data.author and authors[post.data.author] %}
                  <span>by <a href="/authors/{{ post.data.author }}/" class="rec-author-link">{{ authors[post.data.author].name }}</a></span>
                {% endif %}
                {% if post.data.readingTime %}
                  <span>{{ post.data.readingTime.text }}</span>
                {% endif %}
              </div>
              {% if post.data.description %}
                <p class="rec-post-excerpt">{{ post.data.description | truncate(120) }}</p>
              {% endif %}
              {% if post.data.tags %}
                <div class="shared-tags">
                  {% for tag in post.data.tags | head(3) %}
                    {% if tag != "posts" %}
                      <span class="shared-tag">#{{ tag }}</span>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Random Discovery (if not enough related content) -->
    {% if relatedByTags.length < 2 %}
      {% set randomPosts = collections.posts | reject("url", page.url) | randomSample(2) %}
      {% if randomPosts.length > 0 %}
        <div class="recommendation-section">
          <h3 class="section-header">
            <span>üé≤</span>
            Random Discovery
          </h3>
          <div class="recommendation-grid">
            {% for post in randomPosts %}
              {% if post.data.title and post.data.author and authors[post.data.author] and post.url %}
              <a href="{{ post.url }}" class="recommendation-card">
                <h4 class="rec-post-title">{{ post.data.title }}</h4>
                <div class="rec-post-meta">
                  {% if post.date %}
                    {% set parsedDate = post.date | parseCMSDate %}
                    {% if parsedDate %}
                      <span>{{ parsedDate | readableDate }}</span>
                    {% endif %}
                  {% endif %}
                  <span>by <a href="/authors/{{ post.data.author }}/" class="rec-author-link">{{ authors[post.data.author].name }}</a></span>
                  {% if post.data.readingTime %}
                    <span>{{ post.data.readingTime.text }}</span>
                  {% endif %}
                </div>
                {% if post.data.description %}
                  <p class="rec-post-excerpt">{{ post.data.description | truncate(120) }}</p>
                {% endif %}
              </a>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <div class="view-more-section">
    <div class="view-more-links">
      <a href="/explore/" class="view-more-link">
        <span>üîç</span>
        Explore All Content
      </a>
      {% if author %}
        <a href="/authors/{{ author }}/" class="view-more-link">
          <span>üë§</span>
          {{ authors[author].name }}'s Profile
        </a>
      {% endif %}
      <a href="/explore/" class="view-more-link">
        <span>üè∑Ô∏è</span>
        Browse by Tags
      </a>
      <a href="/authors/" class="view-more-link">
        <span>üë•</span>
        Authors
      </a>
    </div>

    <p class="algorithm-note">
      Recommendations powered by tag similarity, author affinity, and discovery algorithms
    </p>
  </div>
</div>

<script>
// Recommendation widget functionality
document.addEventListener('DOMContentLoaded', function() {
  const recommendationCards = document.querySelectorAll('.recommendation-card');

  // Add keyboard navigation
  recommendationCards.forEach((card, index) => {
    card.setAttribute('tabindex', '0');

    card.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        window.location.href = this.href;
      }

      // Arrow key navigation
      if (e.key === 'ArrowRight' && index < recommendationCards.length - 1) {
        e.preventDefault();
        recommendationCards[index + 1].focus();
      }

      if (e.key === 'ArrowLeft' && index > 0) {
        e.preventDefault();
        recommendationCards[index - 1].focus();
      }
    });
  });

  // Analytics tracking for recommendations
  recommendationCards.forEach(card => {
    card.addEventListener('click', function() {
      if (window.analytics) {
        const section = this.closest('.recommendation-section').querySelector('.section-header').textContent.trim();
        window.analytics.track('recommendation_click', {
          section: section,
          target_url: this.href,
          source_url: window.location.href
        });
      }
    });
  });

  // Lazy load recommendation images if any
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
            imageObserver.unobserve(img);
          }
        }
      });
    });

    document.querySelectorAll('img[data-src]').forEach(img => {
      imageObserver.observe(img);
    });
  }

  // Add hover effect with author theme preview
  recommendationCards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      // Get author from the card
      const authorLink = this.querySelector('.rec-author-link');
      if (authorLink) {
        const authorName = authorLink.textContent.trim();
        // Find author key by name
        const authors = {
          {% for authorKey, authorData in authors %}
            "{{ authorData.name }}": "{{ authorKey }}"{% if not loop.last %},{% endif %}
          {% endfor %}
        };

        const authorKey = authors[authorName];
        if (authorKey) {
          // Briefly preview the author's theme
          const currentAuthor = document.documentElement.getAttribute('data-author');
          const authorSelectors = document.querySelectorAll('.author-sync');

          // Store original for restoration
          this.dataset.originalAuthor = currentAuthor;

          // Preview new author theme
          authorSelectors.forEach(selector => {
            selector.value = authorKey;
            selector.dispatchEvent(new Event('change'));
          });
        }
      }
    });

    card.addEventListener('mouseleave', function() {
      // Restore original author theme
      if (this.dataset.originalAuthor) {
        const authorSelectors = document.querySelectorAll('.author-sync');
        authorSelectors.forEach(selector => {
          selector.value = this.dataset.originalAuthor;
          selector.dispatchEvent(new Event('change'));
        });
        delete this.dataset.originalAuthor;
      }
    });
  });

  // Track widget view
  if (window.analytics) {
    window.analytics.track('recommendations_widget_view', {
      post_url: window.location.href,
      recommendations_shown: recommendationCards.length
    });
  }
});
</script>
